<font size=4 face='楷体'>

## MySql 磁盘 IO 过高优化

MySql 磁盘 IO 过高，可能的原因是 日志 binlog 刷入磁盘太过频繁，可以通过下面两个参数进行优化

- innodb_flush_log_at_trx_commit = N

  - N=0 每隔一秒，把事务日志缓存区的数据写到日志文件中，以及把日志文件的数据刷新到磁盘上；

    - log buffer 会 每秒写入到日志文件并刷写（flush）到磁盘。但每次事务提交不会有任何影响，也就是 log buffer 的刷写操作和事务提交操作没有关系。在这种情况下，MySQL 性能最好，但如果 mysqld 进程崩溃，通常会导致最后 1s 的日志丢失。

  - N=1 （默认值） 每个事务提交时候，把事务日志从缓存区写到日志文件中，并且刷新日志文件的数据到磁盘上；

    - 当取值为 1 时，每次事务提交时，log buffer 会被写入到日志文件并刷写到磁盘。这也是默认值。这是最安全的配置，但由于每次事务都需要进行磁盘 I/O，所以也最慢。

  - N=2 每事务提交的时候，把事务日志数据从缓存区写到日志文件中；每隔一秒，刷新一次日志文件，但不一定刷新到磁盘上，而是取决于操作系统的调度；

    - 当取值为 2 时，每次事务提交会写入日志文件，但并不会立即刷写到磁盘，日志文件会每秒刷写一次到磁盘。这时如果 mysqld 进程崩溃，由于日志已经写入到系统缓存，所以并不会丢失数据；在操作系统崩溃的情况下，通常会导致最后 1s 的日志丢失。

- sync_binlog = N （默认值为 1）

  - N>0 每向二进制日志文件写入 N 条 SQL 或 N 个事务后，则把二进制日志文件的数据刷新到磁盘上；
  - N=0 不主动刷新二进制日志文件的数据到磁盘上，而是由操作系统决定；

### 推荐的配置组合

- N=1,1（这也是默认值） — 适合数据安全性要求非常高，而且磁盘 IO 写能力足够支持业务，比如充值消费系统；
- N=1,0 — 适合数据安全性要求高，磁盘 IO 写能力支持业务不富余，允许备库落后或无复制；
- N=2,0 或 2,m(0<m<100) — 适合数据安全性有要求，允许丢失一点事务日志，复制架构的延迟也能接受；
- N=0,0 — 磁盘 IO 写能力有限，无复制或允许复制延迟稍微长点能接受，例如：日志性登记业务；

当两个参数设置为双 1 的时候，写入性能最差  
sync_binlog=N (N>1) 且 innodb_flush_log_at_trx_commit=2 时，MySQL 的写操作才能达到最高性能。

双 1 模式下，当磁盘 IO 无法满足业务需求时  
推荐的做法是

- innodb_flush_log_at_trx_commit = 2
- sync_binlog = N (N 为 500 或 1000 或更高)
- 且使用带蓄电池后备电源的缓存 cache，防止系统断电异常。

```sql
-- 临时变更配置，如要持久化，需要在 my.ini 中进行配置，并重启数据库服务
set global innodb_flush_log_at_trx_commit = 2;
set global sync_binlog = 0;
```

### Reference

[MySql 磁盘 IO 过高优化](https://zhuanlan.zhihu.com/p/610506469)

**2023.09.19**
