<font size=4 face='楷体'>

## Vue 实现企业微信登录

### 大致流程

- 在页面构建二维码
- 扫二维码之后, 微信那边会跳转到 redirect_uri 你重定向的地址, 后面会拼接 code 参数, 一般重定向地址都是本页面
- 在本页面获取 url 后面拼接的 code, 用 code 去请求接口
- 接口那边用 access_token 和 code 去获取用户的企业微信号
- 通过企业微信号查找数据库中是否存在, 存在返回用户的基本信息, 否则不存在返回提示 该用户非企业人员

### 实现

- 引入 js 文件
  参考[官方文档](https://developer.work.weixin.qq.com/document/path/91019)
  vue 直接引入可能会报错, 需要保存下来修改

```html
<script
  src="http://wwcdn.weixin.qq.com/node/wework/wwopen/js/wwLogin-1.2.7.js"
  type="text/javascript"
></script>
```

- 准备好展示二维码节点

```html
<div class="modalDivScanCode" v-show="isRegisterType == 1">
  <h2>你好!</h2>
  <p>请使用 <strong>企业微信</strong> 客户端进行扫码授权</p>
  <!-- <p>Auth Code Sample.</p> -->
  <div id="qr_login"></div>
</div>
```

- 实例化 wwlogin 对象, 挂载到指定的 Dom 节点上

```javascript
mounted:{
    let url = 'https://xxxxxxxxxxx'; // url一般为自己当前的登陆页面, 要做一个回调获取到code
    var wwLogin = new WwLogin({
        id: "qr_login",
        appid: res.appid,
        agentid: res.agentId,
        redirect_uri: encodeURI(url),
        state: res.state,
        href: "",
        lang: "zh",
    })
```

- 获取 code 参数
  扫描二维码并同意后, 页面跳转到`redirect_uri`, 并携带一个 code 参数

```javascript
// vue 监听获取code
watch: {
   "$route.query": {
        handler(newVal, oldVal) {
            console.info(newVal, oldVal)
            this.code = this.$route.query["code"]
         },
        deep: true,
        immediate: true
    }
}
```

```javascript
// js 获取code
function getQueryVariable(code) {
  var query = window.location.search.substring(1)
  var vars = query.split('&')
  for (var i = 0; i < vars.length; i++) {
    var pair = vars[i].split('=')
    if (pair[0] == code) {
      return pair[1]
    }
  }
  return false
}
```

- 将 code 传给后端, 由后端进行身份识别

```javascript
getStaffInfo(){ // 验证企业微信二维码扫码登录
    let params = {
        code:this.code
    }
    auth_qrcode(params).then(res => {
        if(res.length == 0) {
            setTimeout(() => {
                location.href = "https://xxxxxxxxxxx"
                return
            }, 100);
        }
    })
}
```

### Reference

[vue 实现企业微信扫码登陆功能](https://blog.csdn.net/BiangBaing/article/details/122718847)
[Vue 实现企业微信扫码登录](https://blog.csdn.net/sunzhibin1/article/details/108010271)

**2022.08.15**
